<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <title>üöÄ Mega-Admin ‚Äì 1 000 000 000 $</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{--p:#ff6b00;--bg:#f6f8fa;--card:#fff;--red:#e53e3e;--green:#38a169;--blue:#3182ce;--shadow:0 8px 32px rgba(0,0,0,.06);--curve:16px;--font:'Inter',system-ui;}
    *{box-sizing:border-box;margin:0;padding:0;font-family:var(--font);}
    body{background:var(--bg);color:#111;padding-bottom:60px;}
    header{position:sticky;top:0;background:#fff;backdrop-filter:blur(20px);padding:12px 16px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;box-shadow:var(--shadow);z-index:10;}
    button{padding:8px 14px;border:none;border-radius:var(--curve);background:var(--p);color:#fff;font-size:14px;font-weight:600;cursor:pointer;transition:.2s;}
    button:active{transform:scale(.95);}
    .board{padding:16px;display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));}
    .order{background:#fff;border-radius:var(--curve);box-shadow:var(--shadow);padding:14px;display:flex;flex-direction:column;gap:8px;}
    .order.new{border-left:6px solid var(--p);}
    .order.tayyor{border-left-color:var(--blue);}
    .order.yetkazildi{border-left-color:var(--green);}
    .order.bekor{border-left-color:var(--red);}
    .top-row{display:flex;justify-content:space-between;align-items:center;}
    .items{font-size:14px;color:#555;}
    .sum{color:var(--p);font-weight:700;font-size:16px;}
    .acts{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;}
    .login{display:flex;flex-direction:column;gap:12px;align-items:center;margin-top:30vh;padding:0 20px;text-align:center;}
    .login img{width:80px;border-radius:50%;margin-bottom:12px;}
    .empty{padding:40px;text-align:center;opacity:.5;}
    .module{background:var(--card);border-radius:var(--curve);box-shadow:var(--shadow);padding:14px;margin:14px 20px;}
    .module h3{margin-bottom:10px;font-size:17px;}
    textarea{width:100%;min-height:60px;margin-bottom:10px;padding:8px;border:1px solid #ccc;border-radius:var(--curve-sm);}
    input,select{width:100%;padding:8px;margin-bottom:10px;border:1px solid #ccc;border-radius:var(--curve-sm);}
    @media(max-width:400px){.board{grid-template-columns:1fr;}}
  </style>
</head>
<body>

<div id="login" class="login">
  <img src="https://i.ibb.co/20mqx4f8/metbex1-8.jpg" alt="logo">
  <h2>üöÄ Mega-Admin Panel</h2>
  <p>Bot orqali kirish uchun <b>/start</b> ni bosing.</p>
  <button onclick="checkAdmin()">Kirish</button>
</div>

<header id="toolbar" style="display:none">
  <button onclick="loadOrders()">üõí Zakazlar</button>
  <button onclick="showStats()">üìä Statistika</button>
  <button onclick="showProducts()">üçî Mahsulotlar</button>
  <button onclick="showPromos()">üéÅ Promo</button>
  <button onclick="showBroadcast()">üì¢ Rassilka</button>
  <button onclick="showReviews()">‚≠ê Otzyvy</button>
  <button onclick="exportExcel()">üì• Excel</button>
  <button onclick="location.reload()">üîÑ</button>
</header>

<div id="content" style="padding:14px;"></div>

<script>
  const ADMIN_IDS = [7961099561]; // ‚Üê o‚Äòzingizniki
  // API detection: read from <meta name="api-url"> or window.API_URL, fallback to localhost
  function detectApi(){
    try{ const m = document.querySelector('meta[name="api-url"]'); if(m && m.content) return m.content.replace(/\/$/, ''); }catch(e){}
    if(typeof window.API_URL === 'string' && window.API_URL) return window.API_URL.replace(/\/$/, '');
    return 'http://127.0.0.1:8080';
  }
  const API = detectApi(); // use detected API URL

  function checkAdmin() {
    const uid = new URLSearchParams(location.search).get('uid');
    if (!uid) { alert("‚ùå UID topilmadi."); return; }
    if (ADMIN_IDS.includes(parseInt(uid))) {
      document.getElementById('login').style.display = 'none';
      document.getElementById('toolbar').style.display = 'flex';
      loadOrders();
    } else {
      alert("‚ùå Siz admin emassiz.");
    }
  }

  // 1. Zakazlar
  async function loadOrders() {
    const res = await fetch(API + '/api/orders');
    const data = await res.json();
    renderOrders(data.orders || []);
  }

  function renderOrders(orders) {
    const content = document.getElementById('content');
    if (!orders.length) { content.innerHTML = '<p class="empty">Zakazlar yo‚Äòq.</p>'; return; }
    content.innerHTML = orders.map(o => `
      <div class="order ${o.status==='yangi'?'new': o.status==='tayyor'?'tayyor': o.status==='yetkazildi'?'yetkazildi': o.status==='bekor'?'bekor':''}">
        <div class="top-row"><span><b>#${o.id.slice(-6)}</b></span><span class="sum">${o.total.toLocaleString()} so‚Äòm</span></div>
        <div class="items">${o.items.map(it=>`${it.name} x${it.q}`).join(', ')}</div>
        <div>üìû ${o.phone} | ‚è± ${new Date(o.created).toLocaleString('uz-UZ')}</div>
        <div class="acts">
          <button onclick="setStatus('${o.id}','tayyor')">Tayyor</button>
          <button onclick="setStatus('${o.id}','yo\'lda')">Yo‚Äòlda</button>
          <button onclick="setStatus('${o.id}','yetkazildi')">Yetkazildi</button>
          <button onclick="setStatus('${o.id}','bekor')" style="background:#e53e3e">Bekor</button>
        </div>
      </div>`).join('');
  }

  async function setStatus(id, st) {
    await fetch(API + '/api/orders/' + id, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: st })
    });
    loadOrders();
  }

  // 2. Statistika
  async function showStats() {
    const res = await fetch(API + '/api/chart?period=day');
    const data = await res.json();
    const content = document.getElementById('content');
    content.innerHTML = `
      <div class="module">
        <h3>üìä Kunlik daromad</h3>
        <canvas id="chart" width="400" height="200"></canvas>
      </div>`;
    drawChart(data.labels, data.data);
  }

  function drawChart(labels, data) {
    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    const padding = 20;
    const chartWidth = width - 2 * padding;
    const chartHeight = height - 2 * padding;
    const max = Math.max(...data);
    const step = chartWidth / (labels.length - 1);
    ctx.clearRect(0, 0, width, height);
    ctx.beginPath();
    ctx.moveTo(padding, padding + chartHeight - (data[0] / max) * chartHeight);
    for (let i = 1; i < data.length; i++) {
      ctx.lineTo(padding + i * step, padding + chartHeight - (data[i] / max) * chartHeight);
    }
    ctx.strokeStyle = '#ff6b00';
    ctx.lineWidth = 3;
    ctx.stroke();
  }

  // 3. Mahsulotlar
  async function showProducts() {
    const res = await fetch(API + '/api/products');
    const data = await res.json();
    const content = document.getElementById('content');
    content.innerHTML = `
      <div class="module">
        <h3>üçî Mahsulotlar</h3>
        <button onclick="addProduct()">+ Qo‚Äòshish</button>
        <div id="prodList"></div>
      </div>`;
    renderProducts(data.products);
  }

  function renderProducts(list) {
    document.getElementById('prodList').innerHTML = list.map(p => `
      <div class="order">
        <div class="top-row"><span>${p.name}</span><span class="sum">${p.price.toLocaleString()} so‚Äòm</span></div>
        <button onclick="delProduct(${p.id})">O‚Äòchirish</button>
      </div>`).join('');
  }

  async function addProduct() {
    const cat   = prompt("Kategoriya (osh/shorva/kabob/salat/ichimlik/desert):", "osh");
    const name  = prompt("Nomi:");
    const price = parseInt(prompt("Narxi:"));
    const img   = prompt("Rasm (url):");
    if (!cat || !name || !price || !img) return;
    await fetch(API + '/api/products', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ secret: 'megaadmin', cat, name, price, img, rating: 5 })
    });
    showProducts();
  }

  async function delProduct(id) {
    if (!confirm("O‚Äòchirasizmi?")) return;
    await fetch(API + '/api/products/' + id, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ secret: 'megaadmin' })
    });
    showProducts();
  }

  // 4. Promo
  async function showPromos() {
    const res = await fetch(API + '/api/promos');
    const data = await res.json();
    const content = document.getElementById('content');
    content.innerHTML = `
      <div class="module">
        <h3>üéÅ Promo-kodlar</h3>
        <input id="promoCode" placeholder="Kod">
        <input id="promoDisc" placeholder="Chegirma %" type="number">
        <input id="promoMax"  placeholder="Max foydalanish" type="number">
        <button onclick="addPromo()">Yaratish</button>
        <div id="promoList"></div>
      </div>`;
    renderPromos(data.promos);
  }

  function renderPromos(list) {
    document.getElementById('promoList').innerHTML = list.map(p => `
      <div class="order">
        <div class="top-row"><span><b>${p.code}</b></span><span class="sum">-${p.discount}%</span></div>
        <div>Uses: ${p.uses} / ${p.max_uses}</div>
      </div>`).join('');
  }

  async function addPromo() {
    const code = document.getElementById('promoCode').value;
    const disc = parseInt(document.getElementById('promoDisc').value);
    const max  = parseInt(document.getElementById('promoMax').value);
    if (!code || !disc || !max) return;
    await fetch(API + '/api/promos', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ secret: 'megaadmin', code, discount: disc, max_uses: max })
    });
    showPromos();
  }

  // 5. –†–∞—Å—Å—ã–ª–∫–∞
  function showBroadcast() {
    const content = document.getElementById('content');
    content.innerHTML = `
      <div class="module">
        <h3>üì¢ Rassilka</h3>
        <textarea id="broadcastText" placeholder="Xabar matni..."></textarea>
        <button onclick="sendBroadcast()">Yuborish</button>
      </div>`;
  }

  async function sendBroadcast() {
    const text = document.getElementById('broadcastText').value;
    if (!text) return;
    const res = await fetch(API + '/api/broadcast', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ secret: 'megaadmin', text })
    });
    const data = await res.json();
    alert(data.sent + " ta foydalanuvchiga yuborildi!");
    showBroadcast();
  }

  // 6. –û—Ç–∑—ã–≤—ã
  async function showReviews() {
    const res = await fetch(API + '/api/reviews');
    const data = await res.json();
    const content = document.getElementById('content');
    content.innerHTML = `<div class="module"><h3>‚≠ê Otzyvy</h3><div id="revList"></div></div>`;
    renderReviews(data.reviews);
  }

  function renderReviews(list) {
    if (!list.length) { document.getElementById('revList').innerHTML = '<p class="empty">Tekshiruvda otzyvy yo‚Äòq.</p>'; return; }
    document.getElementById('revList').innerHTML = list.map(r => `
      <div class="order">
        <div class="top-row"><span>User ${r.user_id}</span><span>‚≠ê ${r.stars}</span></div>
        <div>${r.text}</div>
        <button onclick="approveReview(${r.id})">Tasdiqlash</button>
      </div>`).join('');
  }

  async function approveReview(id) {
    await fetch(API + '/api/reviews/' + id + '/approve', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ secret: 'megaadmin' })
    });
    showReviews();
  }
